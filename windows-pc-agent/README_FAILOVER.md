# üõ°Ô∏è –û–¢–ö–ê–ó–û–£–°–¢–û–ô–ß–ò–í–û–°–¢–¨ - –ü–æ–ª–Ω–∞—è –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è

## ‚úÖ –í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–µ –º–µ—Ö–∞–Ω–∏–∑–º—ã

### 1. **Multiple Fallback Servers**

```yaml
server:
  url: "https://adb.leetpc.com"
  fallback_urls:
    - "https://sphereadb-api-v2.ru.tuna.am"
    - "https://backup1.leetpc.com"
    - "https://backup2.leetpc.com"
```

**–†–∞–±–æ—Ç–∞–µ—Ç —Ç–∞–∫:**
1. –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ `adb.leetpc.com`
2. –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí `sphereadb-api-v2.ru.tuna.am`
3. –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí `backup1.leetpc.com`
4. –ï—Å–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí `backup2.leetpc.com`
5. –ï—Å–ª–∏ –≤—Å–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ‚Üí –≤–µ—Ä–Ω—É—Ç—å—Å—è –∫ `adb.leetpc.com`

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏:**
- Timeout –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
- Connection refused
- Network error
- Server crash

---

### 2. **Auto-Reconnect —Å Exponential Backoff**

```python
–ü–æ–ø—ã—Ç–∫–∞ 1: 1 —Å–µ–∫—É–Ω–¥–∞
–ü–æ–ø—ã—Ç–∫–∞ 2: 2 —Å–µ–∫—É–Ω–¥—ã
–ü–æ–ø—ã—Ç–∫–∞ 3: 4 —Å–µ–∫—É–Ω–¥—ã
–ü–æ–ø—ã—Ç–∫–∞ 4: 8 —Å–µ–∫—É–Ω–¥
–ü–æ–ø—ã—Ç–∫–∞ 5: 16 —Å–µ–∫—É–Ω–¥
–ü–æ–ø—ã—Ç–∫–∞ 6: 32 —Å–µ–∫—É–Ω–¥
–ü–æ–ø—ã—Ç–∫–∞ 7+: 60 —Å–µ–∫—É–Ω–¥ (–º–∞–∫—Å–∏–º—É–º)
```

**–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π reconnect –ø–æ–∫–∞ –Ω–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è!**

---

### 3. **Heartbeat Monitoring**

```python
–ö–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥:
    –û—Ç–ø—Ä–∞–≤–∏—Ç—å heartbeat {
        "type": "heartbeat",
        "cpu_usage": 45,
        "ram_usage": 60,
        "timestamp": 1704300000000
    }
    
–ï—Å–ª–∏ –Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞ 90 —Å–µ–∫—É–Ω–¥:
    –°—á–∏—Ç–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –º—ë—Ä—Ç–≤—ã–º
    –ò–Ω–∏—Ü–∏–∏—Ä—É–µ–º reconnect
```

---

### 4. **WebSocket Ping/Pong**

```python
–í—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π WebSocket ping –∫–∞–∂–¥—ã–µ 20 —Å–µ–∫—É–Ω–¥
Timeout ping: 20 —Å–µ–∫—É–Ω–¥

–ï—Å–ª–∏ pong –Ω–µ –ø–æ–ª—É—á–µ–Ω:
    WebSocket –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ—Ç—Å—è
    –°—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç reconnect
```

---

### 5. **Graceful Disconnect**

```python
–ü—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:
    1. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å heartbeat
    2. –û—Ç–ø—Ä–∞–≤–∏—Ç—å disconnect message
    3. –ó–∞–∫—Ä—ã—Ç—å WebSocket gracefully
    4. –û—Å–≤–æ–±–æ–¥–∏—Ç—å —Ä–µ—Å—É—Ä—Å—ã
    5. –ù–∞—á–∞—Ç—å reconnect (–µ—Å–ª–∏ –Ω–µ shutdown)
```

---

## üéØ –°—Ü–µ–Ω–∞—Ä–∏–∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω

```
–í—Ä–µ–º—è | –°–æ–±—ã—Ç–∏–µ
------|--------
0:00  | –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ adb.leetpc.com
0:30  | Timeout ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ sphereadb-api-v2.ru.tuna.am
0:31  | ‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ fallback
0:31  | –û—Ç–ø—Ä–∞–≤–∫–∞ hello ‚Üí registered
0:31  | Heartbeat –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –í—Å–µ —Å–µ—Ä–≤–µ—Ä—ã –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã

```
–í—Ä–µ–º—è | –°–æ–±—ã—Ç–∏–µ
------|--------
0:00  | –ü–æ–ø—ã—Ç–∫–∞ adb.leetpc.com ‚Üí timeout
0:30  | –ü–æ–ø—ã—Ç–∫–∞ sphereadb-api-v2 ‚Üí timeout
1:00  | –ü–æ–ø—ã—Ç–∫–∞ backup1 ‚Üí timeout
1:30  | –ü–æ–ø—ã—Ç–∫–∞ backup2 ‚Üí timeout
2:00  | –í–µ—Ä–Ω—É–ª–∏—Å—å –∫ adb.leetpc.com
2:01  | –ñ–¥—ë–º 1 —Å–µ–∫—É–Ω–¥—É (backoff #1)
2:02  | –ü–æ–ø—ã—Ç–∫–∞ adb.leetpc.com ‚Üí timeout
...   | Exponential backoff –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°–µ—Ä–≤–µ—Ä —É–ø–∞–ª –≤–æ –≤—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã

```
–í—Ä–µ–º—è | –°–æ–±—ã—Ç–∏–µ
------|--------
0:00  | ‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ, —Ä–∞–±–æ—Ç–∞–µ–º –Ω–æ—Ä–º–∞–ª—å–Ω–æ
5:00  | Heartbeat –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
5:00  | –°–µ—Ä–≤–µ—Ä —É–ø–∞–ª (–Ω–µ—Ç –æ—Ç–≤–µ—Ç–∞)
5:30  | Heartbeat –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω ‚Üí failed
5:30  | WebSocket –∑–∞–∫—Ä—ã—Ç (ping timeout)
5:30  | Reconnect ‚Üí –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ fallback
5:31  | ‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ fallback
```

### –°—Ü–µ–Ω–∞—Ä–∏–π 4: –°–µ—Ç—å –ø—Ä–æ–ø–∞–ª–∞

```
–í—Ä–µ–º—è | –°–æ–±—ã—Ç–∏–µ
------|--------
0:00  | ‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ
5:00  | –°–µ—Ç—å –æ—Ç–∫–ª—é—á–µ–Ω–∞
5:30  | Heartbeat failed ‚Üí –Ω–∞—á–∏–Ω–∞–µ–º reconnect
5:31  | –ü–æ–ø—ã—Ç–∫–∞ #1 ‚Üí network unreachable (–∂–¥—ë–º 1—Å)
5:32  | –ü–æ–ø—ã—Ç–∫–∞ #2 ‚Üí network unreachable (–∂–¥—ë–º 2—Å)
5:34  | –ü–æ–ø—ã—Ç–∫–∞ #3 ‚Üí network unreachable (–∂–¥—ë–º 4—Å)
...   | –ü—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–æ–ø—ã—Ç–∫–∏
10:00 | –°–µ—Ç—å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞
10:05 | –ü–æ–ø—ã—Ç–∫–∞ #N ‚Üí ‚úì –ø–æ–¥–∫–ª—é—á–µ–Ω–æ!
```

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è

–ê–≥–µ–Ω—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞–µ—Ç:

```python
ConnectionStats {
    connected_at: 1704300000.123,
    last_message_at: 1704300045.456,
    reconnect_count: 3,
    messages_sent: 150,
    messages_received: 148,
    bytes_sent: 45678,
    bytes_received: 123456
}
```

–î–æ—Å—Ç—É–ø–Ω–æ –≤ –≤–µ–±-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ!

---

## üîç –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

### –õ–æ–≥–∏ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏:

```
2026-01-03 19:30:00 | INFO     | –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ wss://adb.leetpc.com/api/v1/pc/ws...
2026-01-03 19:30:30 | ERROR    | –¢–∞–π–º–∞—É—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ wss://adb.leetpc.com/api/v1/pc/ws
2026-01-03 19:30:30 | INFO     | –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ fallback #1/4
2026-01-03 19:30:30 | INFO     | –ò—Å–ø–æ–ª—å–∑—É–µ–º fallback —Å–µ—Ä–≤–µ—Ä: wss://sphereadb-api-v2.ru.tuna.am/api/v1/pc/ws
2026-01-03 19:30:31 | INFO     | ‚úì –ü–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —Å–µ—Ä–≤–µ—Ä—É
2026-01-03 19:30:31 | INFO     | ‚úì –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –∫–∞–∫ MyPC (abc12345...)
```

---

## ‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∞

### –ö–æ–Ω—Ñ–∏–≥ –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏:

```yaml
server:
  url: "https://adb.leetpc.com"
  fallback_urls:
    - "https://sphereadb-api-v2.ru.tuna.am"
    - "https://backup1.leetpc.com"
    - "https://backup2.leetpc.com"
    - "http://192.168.1.100:8000"  # –õ–æ–∫–∞–ª—å–Ω—ã–π —Å–µ—Ä–≤–µ—Ä

connection:
  heartbeat_interval: 30        # Heartbeat –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫
  connect_timeout: 30           # Timeout –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è
  max_reconnect_delay: 60       # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ reconnect
  initial_reconnect_delay: 1    # –ù–∞—á–∞–ª—å–Ω–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞
```

### –î–ª—è –Ω–µ—Å—Ç–∞–±–∏–ª—å–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–∞:

```yaml
connection:
  heartbeat_interval: 15        # –ß–∞—â–µ –ø—Ä–æ–≤–µ—Ä—è–µ–º
  connect_timeout: 60           # –ë–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –Ω–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
  max_reconnect_delay: 120      # –ë–æ–ª—å—à–µ –≤—Ä–µ–º–µ–Ω–∏ –º–µ–∂–¥—É –ø–æ–ø—ã—Ç–∫–∞–º–∏
  initial_reconnect_delay: 2
```

---

## üéØ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–∫–∞–∑–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç–∏

### Test 1: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ –æ—Å–Ω–æ–≤–Ω–æ–≥–æ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –û—Å—Ç–∞–Ω–æ–≤–∏ backend
sudo systemctl stop sphereadb

# –ü—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ –∞–≥–µ–Ω—Ç–∞
tail -f logs/agent.log

# –î–æ–ª–∂–µ–Ω —É–≤–∏–¥–µ—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ fallback
```

### Test 2: –û—Ç–∫–ª—é—á–µ–Ω–∏–µ —Å–µ—Ç–∏

```bash
# Windows: –æ—Ç–∫–ª—é—á–∏ Wi-Fi/Ethernet
# Linux: sudo ifconfig eth0 down

# –ê–≥–µ–Ω—Ç –Ω–∞—á–Ω—ë—Ç reconnect
# –í–∫–ª—é—á–∏ —Å–µ—Ç—å –æ–±—Ä–∞—Ç–Ω–æ - –∞–≥–µ–Ω—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è
```

### Test 3: Kill –ø—Ä–æ—Ü–µ—Å—Å–∞ backend

```bash
# Kill –ø—Ä–æ—Ü–µ—Å—Å–∞
sudo killall -9 python

# –ê–≥–µ–Ω—Ç –æ–±–Ω–∞—Ä—É–∂–∏—Ç disconnect –∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—Å—è
```

---

## ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏–∏

1. **–ê–≥–µ–Ω—Ç –ù–ò–ö–û–ì–î–ê –Ω–µ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è** –ø–æ–∫–∞ –Ω–µ –ø–æ–ª—É—á–∏—Ç SIGTERM/SIGINT
2. **–ë–µ—Å–∫–æ–Ω–µ—á–Ω—ã–π reconnect** —Å exponential backoff
3. **–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ** –Ω–∞ fallback —Å–µ—Ä–≤–µ—Ä—ã
4. **Graceful handling** –≤—Å–µ—Ö –æ—à–∏–±–æ–∫ —Å–µ—Ç–∏
5. **Heartbeat –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** –¥–ª—è –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è "–∑–∞–≤–∏—Å—à–∏—Ö" —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–π

**–ê–ì–ï–ù–¢ –†–ê–ë–û–¢–ê–ï–¢ –í–°–ï–ì–î–ê!** üöÄ
